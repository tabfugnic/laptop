#!/bin/bash

source lib/utils.sh

trap 'ret=$?; test $ret -ne 0 && tail $HOME/logfile.txt >&2; exit $ret' EXIT

set -e

working_directory=`pwd`

while getopts ":v" opt; do
    case $opt in
        v)
            export VERBOSE=true
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            ;;
    esac
done


# Check ssh key
if [ ! -f ~/.ssh/id_rsa.pub ]; then
    error_echo "Setup ssh key before continuing"
    exit 1
fi

# Check pgp key
if [ ! -f ~/.gnupg/pubring.kbx ]; then
    error_echo "Setup pgp key before continuing"
    exit 1
fi

# Install required dependencies
cd $working_directory
sudo -u root bash ./debian.base

# Root User
cd $working_directory
sudo -u root bash ./debian.root $USER

# Home User
cd $working_directory
bash ./debian.local

# Cleanup
$HOME/bin/i3exit reboot
unset VERBOSE
